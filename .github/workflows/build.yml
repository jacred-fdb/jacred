name: Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_run:
    workflows:
      - Release
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

env:
  DOTNET_VERSION: "9.0.x"

permissions:
  contents: write
  actions: read
  packages: read
  id-token: write

jobs:
  build:
    name: ${{ matrix.artifact_name }}
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - runtime: linux-arm64
            output_dir: linux-arm64
            artifact_name: jacred-linux-arm64
          - runtime: linux-x64
            output_dir: linux-amd64
            artifact_name: jacred-linux-amd64
          - runtime: win-x64
            output_dir: windows-x64
            artifact_name: jacred-windows-x64
          - runtime: osx-arm64
            output_dir: osx-arm64
            artifact_name: jacred-osx-arm64
          - runtime: osx-x64
            output_dir: osx-amd64
            artifact_name: jacred-osx-amd64
    steps:
      - name: Determine checkout ref
        id: checkout_ref
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "Fetching latest release tag from API..."
            MAX_RETRIES=5
            RETRY_COUNT=0
            TAG=""
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              RELEASE=$(curl -sSf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases?per_page=1" | jq -r '.[0]')
              TAG=$(echo "$RELEASE" | jq -r '.tag_name')
              if [ -n "$TAG" ] && [ "$TAG" != "null" ]; then
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Retry $RETRY_COUNT/$MAX_RETRIES: Release not yet available, waiting 2 seconds..."
                sleep 2
              fi
            done
            if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
              echo "Error: Could not fetch release tag from API after $MAX_RETRIES attempts"
              exit 1
            fi
            REF="$TAG"
            echo "Using workflow_run event tag: $REF"
          else
            REF="${{ github.ref }}"
            echo "Using default ref: $REF"
          fi
          if [ -z "$REF" ]; then
            echo "Error: Checkout ref is empty"
            exit 1
          fi
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "Checking out ref: $REF"

      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          ref: ${{ steps.checkout_ref.outputs.ref }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v5.1.0
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Dontet format code
        run: dotnet format JacRed.csproj --verify-no-changes
        working-directory: ./
        continue-on-error: false
      - name: Restore
        run: dotnet restore --verbosity minimal

      - name: Publish ${{ matrix.artifact_name }}
        run: |
          dotnet publish JacRed.csproj \
            --configuration Release \
            --runtime ${{ matrix.runtime }} \
            --output ${{ runner.temp }}/${{ matrix.output_dir }} \
            --self-contained true \
            -p:PublishTrimmed=false \
            -p:PublishSingleFile=true \
            -p:DebugType=None \
            -p:EnableCompressionInSingleFile=true \
            -p:OptimizationPreference=Speed \
            -p:SuppressTrimAnalysisWarnings=true \
            -p:IlcOptimizationPreference=Speed \
            -p:IlcFoldIdenticalMethodBodies=true \
            --verbosity minimal

      - name: Upload artifact ${{ matrix.artifact_name }}
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ runner.temp }}/${{ matrix.output_dir }}
          retention-days: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && 30 || 7 }}

  extract-docker-version:
    name: Version for Docker
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_latest: ${{ steps.version.outputs.tag_latest }}
    steps:
      - name: Get release tag
        if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
        id: tag_api
        run: |
          RELEASE=$(curl -sSf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases?per_page=1" | jq -r '.[0]')
          echo "tag=$(echo "$RELEASE" | jq -r '.tag_name')" >> "$GITHUB_OUTPUT"
          echo "prerelease=$(echo "$RELEASE" | jq -r '.prerelease')" >> "$GITHUB_OUTPUT"

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            v="${{ steps.tag_api.outputs.tag }}"
            prerelease="${{ steps.tag_api.outputs.prerelease }}"
          else
            v=""
            prerelease="true"
          fi
          # Strip only leading 'v' so 2.0.0-dev2 and v2.0.0-dev2 both become 2.0.0-dev2
          [ -n "$v" ] && v="${v#v}" || true
          echo "version=$v" >> "$GITHUB_OUTPUT"
          # Tag as 'latest' only for full releases (not pre-releases)
          [ "$prerelease" = "false" ] && echo "tag_latest=true" >> "$GITHUB_OUTPUT" || echo "tag_latest=false" >> "$GITHUB_OUTPUT"

  build-docker-image:
    name: Build and push Docker image
    needs: extract-docker-version
    permissions:
      actions: read
      contents: write
      packages: write
      id-token: write
      attestations: write
      artifact-metadata: write
    uses: ./.github/workflows/reusable-docker-build.yml
    with:
      image: ${{ vars.IMAGE_NAME || 'jacred' }}
      version: ${{ needs.extract-docker-version.outputs.version }}
      tag_latest: ${{ needs.extract-docker-version.outputs.tag_latest }}
      push: ${{ github.ref == 'refs/heads/main' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
      attest_github: ${{ github.ref == 'refs/heads/main' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
      sbom: true
      provenance: "mode=max"
      generate_syft_sbom: true
      sbom_artifact_retention_days: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && 30 || 14 }}

  upload-release-assets:
    name: Attach artifacts to release
    needs: build
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Get release tag
        id: release_tag
        run: |
          RELEASE=$(curl -sSf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases?per_page=1" | jq -r '.[0]')
          TAG=$(echo "$RELEASE" | jq -r '.tag_name')
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Set release tag
        id: set_tag
        run: |
          echo "tag=${{ steps.release_tag.outputs.tag }}" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v7.0.0
        with:
          pattern: "jacred-*-*"
          path: artifacts
          merge-multiple: false

      - name: Create release archives
        id: archives
        run: |
          set -e
          RELEASE_DIR=release-files
          mkdir -p "$RELEASE_DIR"

          for artifact_dir in artifacts/*/; do
            name=$(basename "$artifact_dir")
            (cd "$artifact_dir" && zip -r "../../$RELEASE_DIR/${name}.zip" .)
          done

          {
            echo 'files<<EOF'
            ls -1 "$RELEASE_DIR"/*.zip
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.set_tag.outputs.tag }}
          files: ${{ steps.archives.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
